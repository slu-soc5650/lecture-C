---
title: "Lecture-C Example Notebook - Complete"
author: "Christopher Prener, Ph.D."
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output: 
  github_document: default
  html_notebook: default 
---

## Introduction
This notebook provides examples 

## New Package
We need a new package, `nngeo`, that can be installed with the following script:

```{r install-nngeo, include = FALSE}
# install.packages("nngeo")
```

## Dependencies
This notebook requires the following packages

```{r load-packages}
# tidyverse packages
library(dplyr)    # data wrangling

# spatial packages
library(mapview)  # preview spatial data
library(nngeo)    # eliminiate holes
library(sf)       # spatial tools

# other packages
library(here)     # file path management
```

## Load Data
This notebook requires three files:

```{r load-data}
# precinct data
precinct <- st_read(here("data", "example-data", "POL_WRD_2010_Prec", "POL_WRD_2010_Prec.shp"), 
                    stringsAsFactors = FALSE) %>%
  st_transform(crs = 26915)

# COVID zip code data
city <- st_read(here("data", "example-data", "daily_snapshot_stl_city.geojson"), 
                crs = 4326, stringsAsFactors = FALSE) %>%
  st_transform(crs = 26915)

county <- st_read(here("data", "example-data", "daily_snapshot_stl_county.geojson"), 
                  crs = 4326, stringsAsFactors = FALSE) %>%
  st_transform(crs = 26915)
```

## Dissolving Features
In our `preinct` data, we have a variable named `WARD10`. This is the City Ward that each preinct falls within. If we wanted to map wards instead of precincts, we can modify our geometric data using `group_by()` and `summarise()`:

```{r dissolve-ward}
precinct %>%
  select(WARD10) %>%
  rename(ward = WARD10) %>%
  group_by(ward) %>%
  summarise() -> ward
```

Once these have been dissolved, we can explore them with `mapview()`:

```{r explore-ward}
mapview(ward)
```

Notice how some wards, such as Ward 4 and Ward 21 in North City, Ward 6 and Ward 7 in Downtown, and Wards 12, 15, and 23 in South City have "holes." These are common artifacts of the dissolve process that result from precincts' geometries not *perfectly* abutting each other.

The `nngeo` package has a great function `st_remove_holes()` that can be used to get rid of these:

```{r remove-ward-holes}
ward <- st_remove_holes(ward)
```

We can check out the differences with `mapview()`:

```{r check-ward}
mapview(ward)
```

Be careful with removing holes, particularly if your features have enclaves in them (as Kansas City does) - those enclaves will get removed as well, and `st_difference()` will have to be used to cut the enclaves back out!

## Merging Features
Sometimes, we get data that we want to use in separate files, such as the `city` and `county` COVID data (current as of 2020-04-19). We can use `rbind()` to combine them. 

```{r merge}
region <- rbind(city, county)
```

Be sure to check them first to make sure they have the same names/types of columns to prevent issues with your bound data!

Once these have been merged, we can explore them with `mapview()`:

```{r explore-region}
mapview(region, zcol = "zip")
```

Notice that zip codes that lie along the city-county boundary are split. We can use the dissolve features workflow to combine them!

```{r dissolve-zips}
region %>%
  select(zip, confirmed) %>%
  group_by(zip) %>%
  summarise(confirmed = sum(confirmed, na.rm = TRUE)) -> region
```

Once these have been dissolved, we can explore them with `mapview()`:

```{r explore-dissolved-region}
mapview(region, zcol = "zip")
```



```{r move-to-docs, include=FALSE}
# you do need to include this in any notebook you create for this class
fs::file_copy(here::here("examples", "lecture-C-complete.nb.html"), 
              here::here("docs", "index.nb.html"), 
              overwrite = TRUE)
```

