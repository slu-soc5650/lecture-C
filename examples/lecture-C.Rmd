---
title: "Lecture-C Example Notebook - Complete"
author: "Christopher Prener, Ph.D."
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output: 
  github_document: default
  html_notebook: default 
---

## Introduction
This notebook provides examples 

## New Package
We need a new package, `nngeo`, that can be installed with the following script:

```{r install-nngeo, include = FALSE}
# install.packages("nngeo")
```

## Dependencies
This notebook requires the following packages

```{r load-packages}
# tidyverse packages
library(dplyr)    # data wrangling

# spatial packages
library(mapview)  # preview spatial data
library(nngeo)    # eliminiate holes
library(sf)       # spatial tools

# other packages
library(here)     # file path management
```

## Load Data
This notebook requires three files:

```{r load-data}
# precinct data
precinct <- st_read(here("data", "example-data", "POL_WRD_2010_Prec", "POL_WRD_2010_Prec.shp"), 
                    stringsAsFactors = FALSE) %>%
  st_transform(crs = 26915)

# COVID zip code data
city <- st_read(here("data", "example-data", "daily_snapshot_stl_city.geojson"), 
                crs = 4326, stringsAsFactors = FALSE) %>%
  st_transform(crs = 26915)

county <- st_read(here("data", "example-data", "daily_snapshot_stl_county.geojson"), 
                  crs = 4326, stringsAsFactors = FALSE) %>%
  st_transform(crs = 26915)
```

## Dissolving Features
In our `preinct` data, we have a variable named `WARD10`. This is the City Ward that each preinct falls within. If we wanted to map wards instead of precincts, we can modify our geometric data using `group_by()` and `summarise()`:

```{r dissolve-ward}

```

Once these have been dissolved, we can explore them with `mapview()`:

```{r explore-ward}

```

Notice how some wards, such as Ward 4 and Ward 21 in North City, Ward 6 and Ward 7 in Downtown, and Wards 12, 15, and 23 in South City have "holes." These are common artifacts of the dissolve process that result from precincts' geometries not *perfectly* abutting each other.

The `nngeo` package has a great function `st_remove_holes()` that can be used to get rid of these:

```{r remove-ward-holes}

```

We can check out the differences with `mapview()`:

```{r check-ward}

```

Be careful with removing holes, particularly if your features have enclaves in them (as Kansas City does) - those enclaves will get removed as well, and `st_difference()` will have to be used to cut the enclaves back out!

## Merging Features
Sometimes, we get data that we want to use in separate files, such as the `city` and `county` COVID data (current as of 2020-04-19). We can use `rbind()` to combine them. 

```{r merge}

```

Be sure to check them first to make sure they have the same names/types of columns to prevent issues with your bound data!

Once these have been merged, we can explore them with `mapview()`:

```{r explore-region}

```

Notice that zip codes that lie along the city-county boundary are split. We can use the dissolve features workflow to combine them!

```{r dissolve-zips}

```

Once these have been dissolved, we can explore them with `mapview()`:

```{r explore-dissolved-region}

```

## Dealing with Geometry Collections
Sometimes when we geoprocess data, we get a mix of geometry types. This occurs with the `region` data, where we get a mix of `"POLYGON"` and `"MULTIPOLYGON"` features:

```{r geometry-types}

```

This is known as a "geometry collection." We can check the attributes of the `geometry` column in `region` to confirm this:

```{r geometry-attributes}

```

We see `"sfc_GEOMETRY"` but expect either `"sfc_POLYGON"` or `"sfc_MULTIPOLYGON"` instead. We can convert to polygon using:

```{r collection-extract}

```

Once these have been merged, we can explore them with `mapview()`:

```{r explore-final}

```
